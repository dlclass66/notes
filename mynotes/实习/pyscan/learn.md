
# 基本介绍

自动化 多线程执行渗透任务全流程操作的工具

# 开发需求

在线程检测函数中增加使用nuc进行扫描的相关方法

# 现有软件架构

只讨论与漏洞检测相关的部分

## 线程架构

python_scan.py 是主进程 也就是执行入口 有四个工作线程

1. task_thread 端口检测线程
2. dirsearch_task_thread 目录爆破线程
3. vulcheck_task_thread 漏洞检测线程
4. vulexp_task_thread 漏洞利用线程

这里只考虑线程3

## 代码结构

这4个工作线程的对应的文件在utils文件夹中 其对应的调用在spaceMaptask中

## 工作流程

在项目的同一目录下.\TaskInfo\task\vulcheck 里面存放扫描任务的要求 使用json格式 
示例如下

```json
{
    "task_id":"1",  
    "scanner_id":"1",  
    "args":"3",  //决定了使用哪种方式进行扫描
    "target":"172.25.231.39",
    "severity":"medium" //扫描漏洞级别
}
```

vulcheck_task_monitor 这个函数会解析文件内容 调用函数执行任务 执行完的结果会被被保存到./result/vulcheck/ 结果有扫描结果和任务完成情况

# 添加方式

1. 给vulcheck_task_monitor增加一个调用函数 调用nuclei进行扫描（args == ‘3’时）
2. 添加了一个按漏洞级别筛选poc的字段 （“severity”）
3. 增加了一个读取nuc进度的方法 原理是得到127.0.0.1:9092/metrics的json数据

# 已知问题

## 有时使用request获取json数据会超过最大重试次数

通过修改最大重试次数已基本解决

## nuc运行到一定阶段可能会卡住

可能是nuc本身运行超时或者请求超过了允许的错误数 可能通过修改nuc配置文件或者修改命令参数解决

# 开发踩坑

## 难以获取nuc输出到stdout的内容

已有的读取进度的方式是通过日志匹配出现分数的文字获取进度 但是nuc自带的日志不会输出进度信息 命令行显示的stats也很难获取 最后通过使用nuc自带的出口到网络端口的方式解决

## 难以将127.0.0.1:9092/metrics的json数据多个合成一个json文件

get到的json文件 每个是一个对象 直接写到文件中 多个对象不行 改为使用列表管理 每次最新的就是列表的最后一个对象

## 多进程相关

thread的target函数后不能加（），这样就变成了直接调用一次

## requests库

如果在nuc还没启动出口进度信息时就就访问端口就会出错 添加睡眠时间和修改最大重试次数可以基本解决

## nuc扫描结束后 读取进度进程仍未结束

通过设置event（共享布尔变量）解决

