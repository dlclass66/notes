
# 基本介绍

项目是一个cpp开发的自动化渗透测试框架

# 工作流程

先创建log实例 再初始化config
主线程创建工作线程（boost线程池）一般一个工作会有两个线程（比如端口扫描需要端口扫描任务分配线程 端口扫描结果处理线程）

任务分配线程主要是从数据库获取信息 根据扫描器空闲情况分配扫描器 生成json文件供调用第三方软件时使用 更新数据库状态（pyscan负责具体调用第三方软件的工作）可能还需要使用sftp把生成的文件传输到运行pyscan的服务器

结果处理线程则是解析pyscan生成的结果（可能处理前还需要把结果文件下载到本地） 然后判断任务是否结束 更新数据库状态

# 可以改进的点

1. 可以使用枚举表示每个task的状态而不是用int 可以增加可读性
2. 有的函数有返回值用来判断操作是否成功 但是可能没有用到返回值 比如main.cpp 73行config.init() 只会返回0

# 具体分析

## issue （任务分发 生成任务文件的线程）

一般每种任务会有一个自定义类 每个类有一个静态方法hasTask() 会到数据库中寻找待下发任务 将信息填充到类中对应的存放待下发任务的map _taskUnIssue中
遍历_taskUnIssue 分配scaner 本地会有g_scanData会保存scanner分配的target 另外还有一个g_scanTaskGroup 保存每个scaner分配的task
遍历g_scanData 每个scaner生成一个json格式的txt文件 通过sftp发送到调用第三方软件的部分运行的服务器 删除本地文件 更新数据库
检查当前的task id是否还有待分发的任务 没有的话更新数据库状态 清除_taskUnIssue 睡眠一个query_time

## download 下载线程

从扫描服务器上下载文件 先下载status文件 解析 根据状态判断进度 更新数据库 如果已经扫描完成 就下载结果文件 删除状态文件

## Monitor 结果处理线程

遍历含有结果文件的文件夹 发现一个结果文件就创建一个线程 解析结果文件 线程执行thread_Process 函数 里面会调用processResultFile函数 解析结果文件 将结果更新到数据库 将结果文件放入targetdir中

## 配置过程

首先将nacos的相关配置放在环境变量中 将数据库及程序的相关配置放在nacos中 程序会有一个线程检查nacos中的重要更改
